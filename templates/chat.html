{% extends 'base.html' %}

{% block title %}Ğ§Ğ°Ñ‚{% endblock %}

{% block content %}
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
    }

    .chat-container {
        width: 400px;
        margin: 50px auto;
        background: #fff;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        height: 500px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chat-header {
        padding: 10px;
        background: #4a76a8;
        color: #fff;
        border-radius: 8px 8px 0 0;
        text-align: center;
        font-weight: bold;
    }

    .chat-messages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
    }

    .message {
        margin-bottom: 10px;
    }

    .message.me {
        text-align: right;
    }

    .message .text {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 12px;
        background: #eee;
        max-width: 70%;
        position: relative;
    }

    .message.me .text {
        background: #dcf8c6;
    }

    .read-status {
        font-size: 12px;
        color: #666;
        margin-left: 6px;
    }

    .typing-indicator {
        min-height: 18px;
        font-size: 13px;
        color: #888;
        margin: 0 10px 5px;
        font-style: italic;
    }

    .chat-input {
        display: flex;
        border-top: 1px solid #ddd;
    }

    .chat-input input {
        flex: 1;
        padding: 10px;
        border: none;
        outline: none;
    }

    .chat-input button {
        padding: 10px 15px;
        border: none;
        background: #4a76a8;
        color: white;
        cursor: pointer;
    }

    .chat-input button:hover {
        background: #3b5f86;
    }

    #emoji-panel {
        display: none;
        position: absolute;
        bottom: 60px;
        left: 10px;
        background: #fff;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        max-width: 360px;
        max-height: 250px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    #emoji-panel .emoji-category {
        margin-bottom: 10px;
    }

    #emoji-panel .category-title {
        font-size: 12px;
        color: #666;
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
    }

    #emoji-panel .emoji {
        cursor: pointer;
        font-size: 24px;
        margin: 3px;
        transition: transform 0.2s;
        display: inline-block;
    }

    #emoji-panel .emoji:hover {
        transform: scale(1.3);
    }

</style>

<div class="chat-container">
    <div class="chat-header">
        Ğ§Ğ°Ñ‚
    </div>

    <div class="chat-messages" id="chat-messages">
        {% for msg in messages %}
            <div class="message {% if msg.sender == request.user %}me{% endif %}" data-id="{{ msg.id }}">
                <div class="text">
                    {{ msg.text }}
                    <span class="chat-time">
                        {{ msg.created_at }}
                    </span>
                    {% if msg.sender == request.user %}
                        <span class="read-status">
                            {% if msg.is_read %}âœ”âœ”{% else %}âœ”{% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="typing-indicator" id="typing-indicator"></div>

    <div class="chat-input">
        <input type="text" id="message-input" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ">
        <button id="send-btn">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
        <button id="emoji-btn" type="button">ğŸ˜€</button>
    </div>

    <!-- ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ñ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ -->
    <div id="emoji-panel">
        <div class="emoji-category">
            <span class="category-title">Ğ¡Ğ¼Ğ°Ğ¹Ğ»Ñ‹</span>
            <span class="emoji">ğŸ˜€</span>
            <span class="emoji">ğŸ˜ƒ</span>
            <span class="emoji">ğŸ˜„</span>
            <span class="emoji">ğŸ˜</span>
            <span class="emoji">ğŸ˜†</span>
            <span class="emoji">ğŸ˜…</span>
            <span class="emoji">ğŸ˜‚</span>
            <span class="emoji">ğŸ¤£</span>
            <span class="emoji">ğŸ˜Š</span>
            <span class="emoji">ğŸ˜‡</span>
            <span class="emoji">ğŸ™‚</span>
            <span class="emoji">ğŸ™ƒ</span>
            <span class="emoji">ğŸ˜‰</span>
            <span class="emoji">ğŸ˜Œ</span>
            <span class="emoji">ğŸ˜</span>
            <span class="emoji">ğŸ¥°</span>
            <span class="emoji">ğŸ˜˜</span>
            <span class="emoji">ğŸ˜—</span>
            <span class="emoji">ğŸ˜™</span>
            <span class="emoji">ğŸ˜š</span>
        </div>

        <div class="emoji-category">
            <span class="category-title">Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¸</span>
            <span class="emoji">ğŸ˜‹</span>
            <span class="emoji">ğŸ˜›</span>
            <span class="emoji">ğŸ˜</span>
            <span class="emoji">ğŸ˜œ</span>
            <span class="emoji">ğŸ¤ª</span>
            <span class="emoji">ğŸ¤¨</span>
            <span class="emoji">ğŸ§</span>
            <span class="emoji">ğŸ¤“</span>
            <span class="emoji">ğŸ˜</span>
            <span class="emoji">ğŸ¤©</span>
            <span class="emoji">ğŸ¥³</span>
            <span class="emoji">ğŸ˜</span>
            <span class="emoji">ğŸ˜’</span>
            <span class="emoji">ğŸ˜</span>
            <span class="emoji">ğŸ˜”</span>
            <span class="emoji">ğŸ˜Ÿ</span>
            <span class="emoji">ğŸ˜•</span>
            <span class="emoji">ğŸ™</span>
            <span class="emoji">ğŸ˜£</span>
            <span class="emoji">ğŸ˜–</span>
            <span class="emoji">ğŸ˜«</span>
            <span class="emoji">ğŸ˜©</span>
            <span class="emoji">ğŸ¥º</span>
            <span class="emoji">ğŸ˜¢</span>
            <span class="emoji">ğŸ˜­</span>
            <span class="emoji">ğŸ˜¤</span>
            <span class="emoji">ğŸ˜ </span>
            <span class="emoji">ğŸ˜¡</span>
            <span class="emoji">ğŸ¤¬</span>
            <span class="emoji">ğŸ¤¯</span>
        </div>

        <div class="emoji-category">
            <span class="category-title">Ğ–ĞµÑÑ‚Ñ‹</span>
            <span class="emoji">ğŸ‘‹</span>
            <span class="emoji">ğŸ¤š</span>
            <span class="emoji">ğŸ–</span>
            <span class="emoji">âœ‹</span>
            <span class="emoji">ğŸ––</span>
            <span class="emoji">ğŸ‘Œ</span>
            <span class="emoji">ğŸ¤Œ</span>
            <span class="emoji">ğŸ¤</span>
            <span class="emoji">âœŒï¸</span>
            <span class="emoji">ğŸ¤</span>
            <span class="emoji">ğŸ¤Ÿ</span>
            <span class="emoji">ğŸ¤˜</span>
            <span class="emoji">ğŸ¤™</span>
            <span class="emoji">ğŸ‘ˆ</span>
            <span class="emoji">ğŸ‘‰</span>
            <span class="emoji">ğŸ‘†</span>
            <span class="emoji">ğŸ‘‡</span>
            <span class="emoji">â˜ï¸</span>
            <span class="emoji">ğŸ‘</span>
            <span class="emoji">ğŸ‘</span>
            <span class="emoji">âœŠ</span>
            <span class="emoji">ğŸ‘Š</span>
            <span class="emoji">ğŸ¤›</span>
            <span class="emoji">ğŸ¤œ</span>
            <span class="emoji">ğŸ‘</span>
            <span class="emoji">ğŸ™Œ</span>
            <span class="emoji">ğŸ‘</span>
            <span class="emoji">ğŸ¤²</span>
            <span class="emoji">ğŸ¤</span>
            <span class="emoji">ğŸ™</span>
        </div>

        <div class="emoji-category">
            <span class="category-title">Ğ¡ĞµÑ€Ğ´Ñ†Ğ°</span>
            <span class="emoji">â¤ï¸</span>
            <span class="emoji">ğŸ§¡</span>
            <span class="emoji">ğŸ’›</span>
            <span class="emoji">ğŸ’š</span>
            <span class="emoji">ğŸ’™</span>
            <span class="emoji">ğŸ’œ</span>
            <span class="emoji">ğŸ–¤</span>
            <span class="emoji">ğŸ¤</span>
            <span class="emoji">ğŸ¤</span>
            <span class="emoji">ğŸ’”</span>
            <span class="emoji">â£ï¸</span>
            <span class="emoji">ğŸ’•</span>
            <span class="emoji">ğŸ’</span>
            <span class="emoji">ğŸ’“</span>
            <span class="emoji">ğŸ’—</span>
            <span class="emoji">ğŸ’–</span>
            <span class="emoji">ğŸ’˜</span>
            <span class="emoji">ğŸ’</span>
        </div>

        <div class="emoji-category">
            <span class="category-title">ĞŸÑ€Ğ°Ğ·Ğ´Ğ½Ğ¸ĞºĞ¸</span>
            <span class="emoji">ğŸ‰</span>
            <span class="emoji">ğŸŠ</span>
            <span class="emoji">ğŸˆ</span>
            <span class="emoji">ğŸ</span>
            <span class="emoji">ğŸ‚</span>
            <span class="emoji">ğŸ„</span>
            <span class="emoji">ğŸƒ</span>
            <span class="emoji">ğŸ†</span>
            <span class="emoji">ğŸ‡</span>
            <span class="emoji">âœ¨</span>
            <span class="emoji">ğŸ€</span>
            <span class="emoji">ğŸ—ï¸</span>
        </div>

        <div class="emoji-category">
            <span class="category-title">Ğ–Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ğµ</span>
            <span class="emoji">ğŸ¶</span>
            <span class="emoji">ğŸ±</span>
            <span class="emoji">ğŸ­</span>
            <span class="emoji">ğŸ¹</span>
            <span class="emoji">ğŸ°</span>
            <span class="emoji">ğŸ¦Š</span>
            <span class="emoji">ğŸ»</span>
            <span class="emoji">ğŸ¼</span>
            <span class="emoji">ğŸ¨</span>
            <span class="emoji">ğŸ¯</span>
            <span class="emoji">ğŸ¦</span>
            <span class="emoji">ğŸ®</span>
            <span class="emoji">ğŸ·</span>
            <span class="emoji">ğŸ¸</span>
            <span class="emoji">ğŸµ</span>
            <span class="emoji">ğŸ™ˆ</span>
            <span class="emoji">ğŸ™‰</span>
            <span class="emoji">ğŸ™Š</span>
        </div>

        <div class="emoji-category">
            <span class="category-title">Ğ•Ğ´Ğ°</span>
            <span class="emoji">ğŸ•</span>
            <span class="emoji">ğŸ”</span>
            <span class="emoji">ğŸŸ</span>
            <span class="emoji">ğŸŒ­</span>
            <span class="emoji">ğŸ¿</span>
            <span class="emoji">ğŸ§‚</span>
            <span class="emoji">ğŸ¥“</span>
            <span class="emoji">ğŸ¥š</span>
            <span class="emoji">ğŸ³</span>
            <span class="emoji">ğŸ§‡</span>
            <span class="emoji">ğŸ¥</span>
            <span class="emoji">ğŸ§ˆ</span>
            <span class="emoji">ğŸ</span>
            <span class="emoji">ğŸ¥</span>
            <span class="emoji">ğŸ¥¨</span>
            <span class="emoji">ğŸ¥¯</span>
            <span class="emoji">ğŸ°</span>
            <span class="emoji">ğŸ‚</span>
            <span class="emoji">ğŸ§</span>
            <span class="emoji">ğŸ¥§</span>
            <span class="emoji">ğŸ«</span>
            <span class="emoji">ğŸ¬</span>
            <span class="emoji">ğŸ­</span>
            <span class="emoji">ğŸ®</span>
            <span class="emoji">ğŸ©</span>
            <span class="emoji">ğŸª</span>
        </div>

        <div class="emoji-category">
            <span class="category-title">ĞĞ°Ğ¿Ğ¸Ñ‚ĞºĞ¸</span>
            <span class="emoji">â˜•</span>
            <span class="emoji">ğŸµ</span>
            <span class="emoji">ğŸ§ƒ</span>
            <span class="emoji">ğŸ¥¤</span>
            <span class="emoji">ğŸ§‹</span>
            <span class="emoji">ğŸº</span>
            <span class="emoji">ğŸ»</span>
            <span class="emoji">ğŸ¥‚</span>
            <span class="emoji">ğŸ·</span>
            <span class="emoji">ğŸ¥ƒ</span>
            <span class="emoji">ğŸ¸</span>
            <span class="emoji">ğŸ¹</span>
        </div>

        <div class="emoji-category">
            <span class="category-title">Ğ¡Ğ¿Ğ¾Ñ€Ñ‚</span>
            <span class="emoji">âš½</span>
            <span class="emoji">ğŸ€</span>
            <span class="emoji">ğŸˆ</span>
            <span class="emoji">âš¾</span>
            <span class="emoji">ğŸ¥</span>
            <span class="emoji">ğŸ¾</span>
            <span class="emoji">ğŸ</span>
            <span class="emoji">ğŸ‰</span>
            <span class="emoji">ğŸ¥</span>
            <span class="emoji">ğŸ±</span>
            <span class="emoji">ğŸ“</span>
            <span class="emoji">ğŸ¸</span>
            <span class="emoji">ğŸ’</span>
            <span class="emoji">ğŸ‘</span>
            <span class="emoji">ğŸ¥</span>
            <span class="emoji">ğŸ</span>
        </div>

        <div class="emoji-category">
            <span class="category-title">Ğ Ğ°Ğ·Ğ½Ğ¾Ğµ</span>
            <span class="emoji">â­</span>
            <span class="emoji">ğŸŒŸ</span>
            <span class="emoji">ğŸ’«</span>
            <span class="emoji">âœ¨</span>
            <span class="emoji">ğŸ”¥</span>
            <span class="emoji">ğŸ’¯</span>
            <span class="emoji">ğŸ’¢</span>
            <span class="emoji">ğŸ’¥</span>
            <span class="emoji">ğŸ’¤</span>
            <span class="emoji">ğŸ’¨</span>
            <span class="emoji">ğŸŒˆ</span>
            <span class="emoji">â˜€ï¸</span>
            <span class="emoji">â›…</span>
            <span class="emoji">â›ˆï¸</span>
            <span class="emoji">ğŸŒ™</span>
            <span class="emoji">âš¡</span>
            <span class="emoji">â„ï¸</span>
            <span class="emoji">ğŸµ</span>
            <span class="emoji">ğŸ¶</span>
            <span class="emoji">ğŸ’°</span>
            <span class="emoji">ğŸ’</span>
        </div>
    </div>

</div>

<script>
    const dialogId = {{ dialog.id }};
    const currentUser = "{{ request.user.username }}";

    const socket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
        + window.location.host
        + '/ws/chat/' + dialogId + '/'
    );

    const messagesDiv = document.getElementById('chat-messages');
    const typingIndicator = document.getElementById('typing-indicator');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    let typingTimer = null;

    socket.onopen = function () {
        tryMarkAsRead();

        if (window.UNREAD_CHATS) {
            delete window.UNREAD_CHATS[dialogId];
            localStorage.setItem('UNREAD_CHATS', JSON.stringify(window.UNREAD_CHATS));
            if (typeof updateHeaderDot === 'function') updateHeaderDot();
        }
    };

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.type === 'typing' && data.username !== currentUser) {
            typingIndicator.textContent = data.is_typing
                ? `${data.username} Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°ĞµÑ‚...`
                : '';
            return;
        }

        if (data.type === 'messages_read' && data.message_ids) {
            data.message_ids.forEach(id => {
                const msg = document.querySelector(
                    `.message.me[data-id="${id}"] .read-status`
                );
                if (msg) msg.textContent = 'âœ”âœ”';
            });
            return;
        }


        if (data.message) {
            typingIndicator.textContent = '';
            addMessage(data.sender, data.message, data.id);

            setTimeout(tryMarkAsRead, 0);
        }
    };

    function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        socket.send(JSON.stringify({ message: text }));
        input.value = '';
    }

    sendBtn.onclick = sendMessage;

    input.addEventListener('keydown', e => {
        if (e.key === 'Enter') sendMessage();
    });

    input.addEventListener('input', () => {
        socket.send(JSON.stringify({ type: 'typing', is_typing: true }));

        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            socket.send(JSON.stringify({ type: 'typing', is_typing: false }));
        }, 1200);
    });

    function addMessage(sender, message, id) {
        const div = document.createElement('div');
        div.classList.add('message');
        div.dataset.id = id;
        readSent = false;
        setTimeout(tryMarkAsRead, 0);

        let readStatus = '';

        if (sender === currentUser) {
            div.classList.add('me');
            readStatus = `<span class="read-status">âœ”</span>`;
        }

        div.innerHTML = `
            <div class="text">
                ${message}
                ${readStatus}
            </div>
        `;

        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    scrollToBottom();

    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPanel = document.getElementById('emoji-panel');
    const messageInput = document.getElementById('message-input');

    emojiBtn.addEventListener('click', () => {
        emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'block' : 'none';
    });

    emojiPanel.querySelectorAll('.emoji').forEach(el => {
        el.addEventListener('click', () => {
            messageInput.value += el.textContent;
            messageInput.focus();
        });
    });

    // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ²Ğ½Ğµ ĞµÑ‘
    document.addEventListener('click', (e) => {
        if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
            emojiPanel.style.display = 'none';
        }
    });



    let windowFocused = true;
    let readSent = false;

    document.addEventListener('visibilitychange', () => {
        windowFocused = !document.hidden;
        tryMarkAsRead();
    });

    function isScrolledToBottom() {
        const threshold = 40;
        return (
            messagesDiv.scrollHeight
            - messagesDiv.scrollTop
            - messagesDiv.clientHeight
        ) < threshold;
    }

    messagesDiv.addEventListener('scroll', tryMarkAsRead);

    function tryMarkAsRead() {
        if (!windowFocused) return;
        if (!isScrolledToBottom()) return;
        if (readSent) return;

        socket.send(JSON.stringify({
            type: 'messages_read',
            dialog_id: dialogId
        }));
        readSent = true;
    }

    let dialogInFocus = document.visibilityState === 'visible';

    document.addEventListener('visibilitychange', () => {
        dialogInFocus = document.visibilityState === 'visible';

        if (dialogInFocus) {
            tryMarkAsRead();
        }
    });

    window.addEventListener('beforeunload', () => {
        readSent = false;
    });

</script>
{% endblock %}