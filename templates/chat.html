{% extends 'base.html' %}

{% block title %}–ß–∞—Ç{% endblock %}

{% block content %}
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
    }

    .chat-container {
        width: 400px;
        margin: 50px auto;
        background: #fff;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        height: 500px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chat-header {
        padding: 10px;
        background: #4a76a8;
        color: #fff;
        border-radius: 8px 8px 0 0;
        text-align: center;
        font-weight: bold;
    }

    .chat-messages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
    }

    .message {
        margin-bottom: 10px;
    }

    .message.me {
        text-align: right;
    }

    .message .text {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 12px;
        background: #eee;
        max-width: 70%;
        position: relative;
    }

    .message.me .text {
        background: #dcf8c6;
    }

    .read-status {
        font-size: 12px;
        color: #666;
        margin-left: 6px;
    }

    .typing-indicator {
        min-height: 18px;
        font-size: 13px;
        color: #888;
        margin: 0 10px 5px;
        font-style: italic;
    }

    .chat-input {
        display: flex;
        border-top: 1px solid #ddd;
    }

    .chat-input input {
        flex: 1;
        padding: 10px;
        border: none;
        outline: none;
    }

    .chat-input button {
        padding: 10px 15px;
        border: none;
        background: #4a76a8;
        color: white;
        cursor: pointer;
    }

    .chat-input button:hover {
        background: #3b5f86;
    }


    #emoji-panel .emoji {
        cursor: pointer;
        font-size: 24px;
        margin: 5px;
        transition: transform 0.2s;
    }

    #emoji-panel .emoji:hover {
        transform: scale(1.3);
    }

</style>

<div class="chat-container">
    <div class="chat-header">
        –ß–∞—Ç
    </div>

    <div class="chat-messages" id="chat-messages">
        {% for msg in messages %}
            <div class="message {% if msg.sender == request.user %}me{% endif %}">
                <div class="text">
                    {{ msg.text }}
                    <span class="chat-time">
                        {{ msg.created_at }}
                    </span>
                    {% if msg.sender == request.user %}
                        <span class="read-status">
                            {% if msg.is_read %}‚úî‚úî{% else %}‚úî{% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="typing-indicator" id="typing-indicator"></div>

    <div class="chat-input">
        <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
        <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="emoji-btn" type="button">üòÄ</button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å —ç–º–æ–¥–∑–∏ -->
    <div id="emoji-panel" style="display:none; position:absolute; bottom:60px; left:10px; background:#fff; border:1px solid #ddd; padding:10px; border-radius:8px; max-width: 300px; flex-wrap: wrap;">
        <span class="emoji">üòÄ</span>
        <span class="emoji">üòÇ</span>
        <span class="emoji">üòç</span>
        <span class="emoji">üòé</span>
        <span class="emoji">üò¢</span>
        <span class="emoji">üëç</span>
        <span class="emoji">üéâ</span>
        <span class="emoji">‚ù§Ô∏è</span>
        <!-- –î–æ–±–∞–≤—å –ª—é–±—ã–µ –Ω—É–∂–Ω—ã–µ —ç–º–æ–¥–∑–∏ -->
    </div>

</div>

<script>
    const dialogId = {{ dialog.id }};
    const currentUser = "{{ request.user.username }}";

    const socket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
        + window.location.host
        + '/ws/chat/' + dialogId + '/'
    );

    const messagesDiv = document.getElementById('chat-messages');
    const typingIndicator = document.getElementById('typing-indicator');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    let typingTimer = null;

// –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket –≤ –¥–∏–∞–ª–æ–≥–µ
    socket.onopen = function() {
        // –û—Ç–º–µ—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
        socket.send(JSON.stringify({
            type: 'messages_read',
            dialog_id: dialogId
        }));

        // –õ–æ–∫–∞–ª—å–Ω–æ —É–±–∏—Ä–∞–µ–º –º–µ—Ç–∫—É
        if (window.UNREAD_CHATS) {
            delete window.UNREAD_CHATS[dialogId];
            localStorage.setItem('UNREAD_CHATS', JSON.stringify(window.UNREAD_CHATS));
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤ —à–∞–ø–∫–µ
            if (typeof updateHeaderDot === 'function') updateHeaderDot();
        }
    }


    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.type === 'typing' && data.username !== currentUser) {
            typingIndicator.textContent = data.is_typing
                ? `${data.username} –ø–µ—á–∞—Ç–∞–µ—Ç...`
                : '';
            return;
        }

        if (data.type === 'messages_read') {
            document.querySelectorAll('.message.me .read-status').forEach(el => {
                el.textContent = '‚úî‚úî';
            });
            return;
        }

        if (data.message) {
            typingIndicator.textContent = '';
            addMessage(data.sender, data.message);
        }
    };

    function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        socket.send(JSON.stringify({ message: text }));
        input.value = '';
    }

    sendBtn.onclick = sendMessage;

    input.addEventListener('keydown', e => {
        if (e.key === 'Enter') sendMessage();
    });

    input.addEventListener('input', () => {
        socket.send(JSON.stringify({ type: 'typing', is_typing: true }));

        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            socket.send(JSON.stringify({ type: 'typing', is_typing: false }));
        }, 1200);
    });

    function addMessage(sender, message) {
        const div = document.createElement('div');
        div.classList.add('message');

        let readStatus = '';

        if (sender === currentUser) {
            div.classList.add('me');
            readStatus = `<span class="read-status">‚úî</span>`;
        }

        div.innerHTML = `
            <div class="text">
                ${message}
                ${readStatus}
            </div>
        `;

        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ –≤–Ω–∏–∑
    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // –°–∫—Ä–æ–ª–ª–∏–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    scrollToBottom();

    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPanel = document.getElementById('emoji-panel');
    const messageInput = document.getElementById('message-input');

    // –æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ —ç–º–æ–¥–∑–∏
    emojiBtn.addEventListener('click', () => {
        emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'flex' : 'none';
    });

    // –≤—Å—Ç–∞–≤–∫–∞ —ç–º–æ–¥–∑–∏ –≤ input
    emojiPanel.querySelectorAll('.emoji').forEach(el => {
        el.addEventListener('click', () => {
            messageInput.value += el.textContent; // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞
            messageInput.focus();
        });
    });

</script>
{% endblock %}
